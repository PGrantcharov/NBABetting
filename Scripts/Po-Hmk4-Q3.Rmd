---
title: "GR5702 EDAV Homework 4 Q3"
author: "Po-Chieh Liu (pl2441)"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)
```

```{r}
library(tidyverse)
df <- read_csv('tidy.csv')

hw4_df <- df %>% select(Date,V, H, V1, V2, V3, V4, H1, H2, H3, H4, OU2H) %>%
  mutate(Year = format(Date, "%Y") ) %>%
  mutate(Q3Q4 = V3+V4+H3+H4) %>%
  mutate(Q1Q2 = V1+V2+H1+H2) %>%
  mutate(Q1 = V1+H1) %>%
  select(Year, Q1, Q1Q2, Q3Q4, OU2H, V, H) 

```

### Quick Introduction 

Supreme Court struck down a 1992 federal law on 2018 May to loose the restrictions on sport betting. Later on, there are several on-line betting services start running. One of our group member is interested in how the house gain profits from computing proper moneylines and predicting final scores. The dataset we have contains the NBA games' data from season 2007 to 2017 including game date, visiting team, home team, scores of each quarter, house predicted final score, and second half scoure and other data which are not used in this assignment. In this assignment, I selected the house estimated 2nd half score data and compared with actual game results. Then applied the 1st quarter score and both 1st and 2nd quarter scores as predictor to predict the 2nd half score. Maybe the score is a good predictor for competing the house 2nd half score line.

#### House 2nd Half Score Accuracy Plot

Following R codes generate two bar charts for comparing the house predicted 2nd half scores verse actual 2nd half scores. From the plots, we can observe that there are around 7,500 games (54%) house were overestimated the scoress and 6,600 games (46%) were underestimated. 

```{r fig.align='center'}
df <- hw4_df %>% select(OU2H, Q3Q4) %>% 
  mutate(performance = if_else(OU2H > Q3Q4, 'Overestimate', 'Underestimate')) 

ggplot(df, aes(x = performance, fill = performance)) +
  geom_bar() +
  scale_y_continuous("Number of Games", breaks = c(0, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000)) +
  scale_x_discrete("House Predicited 2nd Half Score")

ggplot(df, aes(x = performance, fill = performance)) +
  geom_bar(aes(y = (..count..)/sum(..count..))) +
  scale_y_continuous("Percentage of Games", breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5), labels = c('0%', '10%', '20%', '30%', '40%', '50%')) +
  scale_x_discrete("House Predicited 2nd Half Score")
```

#### Predicted 2nd Half Score with Q1 Score and Both Q1 and Q2 Score

The following R codes generate the predictions accuracy bar charts. For applying Q1 score, I assume both teams perform same each quarter, so the 2nd half score will be 2 times Q1 score. For applying Q1+Q2 score, I assume both teams perform same for both 1st and 2nd half games. Therefore, the 2nd half score will be the same.

From the plots, we can observe that around 53% to 55% games were overestimated, and around 45% to 47% games were underestimated. However, the relationship between predicted score and final score is not bet performace. But if we can improve our prediction we can increase our gain chance, which is not considered in this assignment.

```{r fig.align='center'}
df <- hw4_df %>% select(Q1, Q3Q4) %>% 
  mutate(performance = if_else(Q1*2 > Q3Q4, 'Overestimate', 'Underestimate')) 

ggplot(df, aes(x = performance, fill = performance)) +
  geom_bar() +
  scale_y_continuous("Number of Games", breaks = c(0, 2000, 4000, 6000, 8000)) +
  scale_x_discrete("House Predicited 2nd Half Score") +
  coord_cartesian(ylim=c(0,8000))

ggplot(df, aes(x = performance, fill = performance)) +
  geom_bar(aes(y=(..count..)/sum(..count..))) +
  scale_y_continuous("Number of Games", breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5), labels = c('0%', '10%', '20%', '30%', '40%', '50%')) +
  scale_x_discrete("House Predicited 2nd Half Score")+
  coord_cartesian(ylim=c(0,0.55))

df <- hw4_df %>% select(Q1Q2, Q3Q4) %>% 
  mutate(performance = if_else(Q1Q2 > Q3Q4, 'Overestimate', 'Underestimate')) 

ggplot(df, aes(x = performance, fill = performance)) +
  geom_bar() +
  scale_y_continuous("Number of Games", breaks = c(0, 2000, 4000, 6000, 8000)) +
  scale_x_discrete("House Predicited 2nd Half Score") +
  coord_cartesian(ylim=c(0,8000))

ggplot(df, aes(x = performance, fill = performance)) +
  geom_bar(aes(y=(..count..)/sum(..count..))) +
  scale_y_continuous("Number of Games", breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5), labels = c('0%', '10%', '20%', '30%', '40%', '50%')) +
  scale_x_discrete("House Predicited 2nd Half Score") +
  coord_cartesian(ylim=c(0,0.55))
```

#### Predicted 2nd Half Score with Q1 score Performance

The following R codes apply the 1st quarter score to predict the 2nd half score. The gain performance is defined if the actual score and predicted score both either less than or greater than house estimated score. From those plots, if we applied this stregy from 2007 to 2017, we will lose aorund 7,347 games and win 6,839 games by using this stregy.

```{r fig.align='center'}
df <- hw4_df %>% select(Q1, Q3Q4, OU2H) %>% 
  mutate(performance = if_else( ((OU2H>Q3Q4)&(OU2H>2*Q1))|(OU2H<Q3Q4)&(OU2H<2*Q1) ,'Gain','Lost')) 

ggplot(df, aes(x = performance, fill = performance)) +
  geom_bar() +
  scale_y_continuous("Number of Games", breaks = c(0, 1000, 2000, 3000, 4000, 5000, 6000, 7000)) +
  scale_x_discrete("Predicited 2nd Half Score Performance")

df <- hw4_df %>% select(Q1, Q3Q4, OU2H) %>% 
  mutate(performance = if_else( ((OU2H>Q3Q4)&(OU2H>2*Q1))|(OU2H<Q3Q4)&(OU2H<2*Q1) ,'Gain','Lost')) 

ggplot(df, aes(x = performance, fill = performance)) +
  geom_bar(aes(y = (..count..)/sum(..count..))) +
  scale_y_continuous("Percentage of Games", breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5), labels = c('0%', '10%', '20%', '30%', '40%', '50%')) +
  scale_x_discrete("Predicited 2nd Half Score Performance")
```


#### Predicted 2nd Half Score with Q1 and Q2 score Performance

The following R codes apply both 1st and 2nd quarter scores to predict the 2nd half score. The performance plots are also generted. The plots are very similar to previous plots. The gain/lost game counts are 6,858 and 7,328 in this case. 

```{r fig.align='center'}
df <- hw4_df %>% select(Q1Q2, Q3Q4, OU2H) %>% 
  mutate(performance = if_else( ((OU2H>Q3Q4)&(OU2H>Q1Q2))|(OU2H<Q3Q4)&(OU2H<Q1Q2) ,'Gain','Lost')) 

ggplot(df, aes(x = performance, fill = performance)) +
  geom_bar() +
  scale_y_continuous("Number of Games", breaks = c(0, 1000, 2000, 3000, 4000, 5000, 6000, 7000)) +
  scale_x_discrete("Predicited 2nd Half Score Performance")

df <- hw4_df %>% select(Q1Q2, Q3Q4, OU2H) %>% 
  mutate(performance = if_else( ((OU2H>Q3Q4)&(OU2H>Q1Q2))|(OU2H<Q3Q4)&(OU2H<Q1Q2) ,'Gain','Lost')) 

ggplot(df, aes(x = performance, fill = performance)) +
  geom_bar(aes(y = (..count..)/sum(..count..))) +
  scale_y_continuous("Percentage of Games", breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5), labels = c('0%', '10%', '20%', '30%', '40%', '50%')) +
  scale_x_discrete("Predicited 2nd Half Score Performance")
```



#### Predicted 2nd Half Score with Q1 and Q2 Score Performance (Yearly)

Previous results show the performance is not good overall. I am curious how the performance of each year. Following R codes shows the yearly performance of both methods. From the plots, we can observe that for using 1st quarter score, only in 2012 the gain count is greater lost count. For using both 1st and 2nd quarter socres, only in 2012 and 2015 the gain counts are greater than lost counts.

```{r fig.align='center'}
df <- hw4_df %>% select(Q1, Q3Q4, OU2H, Year) %>% 
  mutate(performance = if_else( ((OU2H>Q3Q4)&(OU2H>2*Q1))|(OU2H<Q3Q4)&(OU2H<2*Q1) ,'Gain','Lost'))

ggplot(df, aes(x = Year, fill = performance)) +
  geom_bar(position = "dodge") +
  scale_y_continuous("Number of Games") +
  scale_x_discrete("Predicited 2nd Half Score Performance")

df <- hw4_df %>% select(Q1Q2, Q3Q4, OU2H, Year) %>% 
  mutate(performance = if_else( ((OU2H>Q3Q4)&(OU2H>Q1Q2))|(OU2H<Q3Q4)&(OU2H<Q1Q2) ,'Gain','Lost')) 

ggplot(df, aes(x = Year, fill = performance)) +
  geom_bar(position = "dodge") +
  scale_y_continuous("Number of Games") +
  scale_x_discrete("Predicited 2nd Half Score Performance") 
```


#### Predicted 2nd Half Score with Q1 and Q2 Score Performance (By Region)

Next, we group the games by the visiting and home teams region. 1st quarter score method only have gain counts greater than lost counts in year 2007 and 2012 for west team matches, and in year 2012 for east-west team matches, and year 2007, 2010, 2017 for east team matches. 1st and 2nd quarter scores method only have gain counts greater than lost counts in year 2007 and 2012 for west team matches, and in year 2010, 2011, 2012 for east-west team matches, and year 2007, 2010, 2012, 2017 for east team matches. 


```{r fig.align='center', fig.width=8}
East <- c("Atlanta", "Boston", "Brooklyn", "Charlotte", "Chicago", "Cleveland", "Detroit", "Indiana", "Miami", "Milwaukee","NewYork","Orlando","Philadelphia","Toronto","Washington")

df <- hw4_df %>% select(V, H, Q1, Q3Q4, OU2H, Year) %>% 
  mutate(performance = if_else( ((OU2H>Q3Q4)&(OU2H>2*Q1))|(OU2H<Q3Q4)&(OU2H<2*Q1) ,'Gain','Lost')) %>%
  mutate(Vside = if_else(V %in% East, 'East', 'West')) %>%
  mutate(Hside = if_else(H %in% East, 'East', 'West')) %>%
  mutate(side = if_else( Vside == Hside, if_else(Vside == 'East', 'East', 'West'), 'East-West'))

ggplot(df, aes(x = side, fill = performance)) +
  geom_bar(position = "dodge") +
  scale_y_continuous("Number of Games") +
  scale_x_discrete("Predicited 2nd Half Score Performance") +
  facet_wrap(~Year)

df <- hw4_df %>% select(V, H, Q1Q2, Q3Q4, OU2H, Year) %>% 
  mutate(performance = if_else( ((OU2H>Q3Q4)&(OU2H>Q1Q2))|(OU2H<Q3Q4)&(OU2H<Q1Q2) ,'Gain','Lost')) %>%
  mutate(Vside = if_else(V %in% East, 'East', 'West')) %>%
  mutate(Hside = if_else(H %in% East, 'East', 'West')) %>%
  mutate(side = if_else( Vside == Hside, if_else(Vside == 'East', 'East', 'West'), 'East-West'))

ggplot(df, aes(x = side, fill = performance)) +
  geom_bar(position = "dodge") +
  scale_y_continuous("Number of Games") +
  scale_x_discrete("Predicited 2nd Half Score Performance") +
  facet_wrap(~Year)

```

#### Relationship Between Actual Score and Prediction

Previous plots just used the raw scores to predict the 2nd half quarter score in very simple way. In order to check the possible relationship between our predictors and actual scores, the dot plots were generted. From the plots, we can observe the dots show no obvious relationship. All dots are concentrated in the middle of each year plot. 

```{r fig.align='center', fig.width=8}

df <- hw4_df %>% select( Q1, Q1Q2, Q3Q4, Year)

ggplot(df) + 
  geom_point(aes(x=Q1,y=Q3Q4), alpha= 0.1) +
  facet_wrap(~Year) +
  scale_x_continuous("Q1 Score") + 
  scale_y_continuous("2nd Half Score")

ggplot(df) +
  geom_point(aes(x=Q1Q2, y=Q3Q4), alpha= 0.1) +
  facet_wrap(~Year) +
  scale_x_continuous("Q1+Q2 Score") + 
  scale_y_continuous("2nd Half Score")

```

#### Conclusion

The performances of proposed methods in NBA game betting are very bad in my opinion. However, it makes me more curious about how house to compute their total score. That score don't have to be accurate, but have to be profitable for house. Moreover, I personally think using Q1 and Q2 scores to predict the 2nd half game score should be accurate. More complex models and other unused variables will be considered in the final project. 